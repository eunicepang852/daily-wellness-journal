<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>生活助手 | 節氣養生</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/180/8D6E63/FFFFFF?text=生活助手">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F7F3F0; color: #5D4037; -webkit-tap-highlight-color: transparent; }
        .muji-card { background-color: #FFFFFF; border-radius: 24px; box-shadow: 0 4px 15px rgba(93,64,55,0.05); position: relative; }
        .muji-btn { background-color: #8D6E63; color: white; }
        .tab-active { border-bottom: 2px solid #8D6E63; color: #8D6E63; font-weight: 500; }
        input, select, textarea { background-color: #FBF9F7; border: 1px solid #EFEBE9; border-radius: 12px; padding: 14px; outline: none; width: 100%; font-size: 14px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .btn-filter { padding: 8px 18px; border-radius: 20px; font-size: 12px; white-space: nowrap; transition: all 0.2s; border: 1px solid transparent; }
        .btn-filter.active { background-color: #8D6E63; color: white; border-color: #8D6E63; }
        .btn-filter.inactive { background-color: white; color: #A8A29E; border-color: #EFEBE9; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen relative pb-28">

<div id="app">
    <div v-if="!isUnlocked" class="fixed inset-0 z-[100] bg-[#F7F3F0] flex flex-col items-center justify-center p-10">
        <div class="w-16 h-16 muji-btn rounded-2xl flex items-center justify-center mb-6 shadow-lg rotate-3"><i class="fas fa-fingerprint text-2xl"></i></div>
        <h2 class="text-xl font-medium mb-8 text-stone-600">生活助手</h2>
        <input v-model="passInput" type="password" placeholder="請輸入密碼" class="text-center tracking-[0.5em] mb-4 shadow-inner" @keyup.enter="checkPassword">
        <button @click="checkPassword" class="w-full py-4 muji-btn rounded-2xl font-medium shadow-md">驗證身份</button>
    </div>

    <template v-else>
        <header class="bg-white/90 backdrop-blur-md px-6 pt-6 sticky top-0 z-20 border-b border-stone-50">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h1 class="text-2xl font-medium">健康日誌</h1>
                    <p class="text-[9px] opacity-40 tracking-[0.2em] mt-1 uppercase">Solar Terms & Recipes</p>
                </div>
                <div class="text-right">
                    <div class="text-sm font-bold text-[#8D6E63]">{{ currentSolarTerm.name }}</div>
                    <div class="text-[10px] opacity-40">{{ currentDate }}</div>
                </div>
            </div>
            <div class="flex gap-8 text-sm text-stone-300 pb-3 overflow-x-auto no-scrollbar">
                <span @click="tab = 'recommend'" :class="{'tab-active': tab === 'recommend'}" class="cursor-pointer pb-2 whitespace-nowrap">今日建議</span>
                <span @click="tab = 'health'" :class="{'tab-active': tab === 'health'}" class="cursor-pointer pb-2 whitespace-nowrap">健康指標</span>
                <span @click="tab = 'recipes'" :class="{'tab-active': tab === 'recipes'}" class="cursor-pointer pb-2 whitespace-nowrap">共享食譜庫</span>
            </div>
        </header>

        <section v-if="tab === 'recommend'" class="p-6 space-y-8">
            <div class="bg-[#EAE3DB] p-6 rounded-[30px] border border-white/50">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-base font-bold flex items-center gap-2"><i class="fas fa-calendar-alt text-[#8D6E63]"></i> {{ currentSolarTerm.name }}養生</h2>
                    <span class="text-[10px] opacity-40">當令時節</span>
                </div>
                <p class="text-xs leading-relaxed text-stone-600">{{ currentSolarTerm.advice }}</p>
            </div>

            <div class="space-y-4">
                <h3 class="text-[10px] font-bold opacity-30 pl-1 uppercase tracking-widest">今日健康推薦</h3>
                <div v-for="dish in dailyDishes" :key="dish.name" class="muji-card p-5 flex justify-between items-center transition-all active:scale-95">
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-1.5 rounded-full bg-[#D7CCC8]"></div>
                        <div>
                            <div class="font-medium text-sm">{{ dish.name }}</div>
                            <div class="text-[10px] text-[#8D6E63] mt-0.5 font-medium">{{ dish.tag }}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-xs font-bold text-stone-400">{{ dish.cal }} kcal</div>
                        <a :href="'https://www.google.com/search?q=' + dish.name + ' 食譜'" target="_blank" class="text-stone-200 hover:text-[#8D6E63]"><i class="fas fa-search-plus"></i></a>
                    </div>
                </div>
            </div>

            <div class="muji-card p-5 bg-[#FBF9F7] border border-stone-100">
                <div class="flex gap-4 items-center">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-[#8D6E63] shadow-sm"><i class="fas fa-heart"></i></div>
                    <div class="flex-1">
                        <div class="text-[10px] font-bold opacity-30 uppercase">Health Note</div>
                        <div class="text-xs text-stone-500 leading-tight mt-1">均衡飲食，配合 {{ currentSolarTerm.name }} 氣候調整作息，更有助於體質改善。</div>
                    </div>
                </div>
            </div>
        </section>

        <section v-if="tab === 'health'" class="p-6 space-y-6">
            <div class="muji-card p-7">
                <h2 class="text-sm font-bold mb-6 opacity-40 uppercase tracking-widest text-center">Body Composition</h2>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="space-y-1">
                        <label class="text-[10px] opacity-30 ml-2">身高 (cm)</label>
                        <input v-model.number="user.height" type="number" placeholder="cm">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] opacity-30 ml-2">體重 (kg)</label>
                        <input v-model.number="user.weight" type="number" placeholder="kg">
                    </div>
                </div>
                <div class="flex gap-2 mb-6">
                    <button @click="user.gender = 'M'" :class="user.gender === 'M' ? 'muji-btn' : 'bg-stone-50 text-stone-300'" class="flex-1 py-3 rounded-xl text-xs font-medium transition-all">男</button>
                    <button @click="user.gender = 'F'" :class="user.gender === 'F' ? 'muji-btn' : 'bg-stone-50 text-stone-300'" class="flex-1 py-3 rounded-xl text-xs font-medium transition-all">女</button>
                </div>
                <div v-if="bmi" class="text-center p-6 bg-stone-50 rounded-[30px] border border-stone-100 shadow-inner">
                    <div class="text-4xl font-light mb-1 text-stone-700">{{ bmi }}</div>
                    <div class="text-[10px] font-bold opacity-30 mb-4 uppercase tracking-[0.2em]">{{ bmiStatus }}</div>
                    <div class="pt-4 border-t border-stone-200">
                        <div class="text-[11px] opacity-50 mb-1">目標每日攝取 (TDEE)</div>
                        <div class="text-xl font-bold text-[#8D6E63]">{{ recommendedKcal }} <span class="text-xs font-normal">kcal</span></div>
                    </div>
                </div>
            </div>
        </section>

        <section v-if="tab === 'recipes'" class="p-6 space-y-6">
            <div class="flex items-center gap-3 overflow-x-auto no-scrollbar pb-1">
                <button @click="filterCuisine = '全部'" :class="filterCuisine === '全部' ? 'active' : 'inactive'" class="btn-filter shadow-sm">全部</button>
                <button v-for="c in cuisines" :key="c" @click="filterCuisine = c" :class="filterCuisine === c ? 'active' : 'inactive'" class="btn-filter shadow-sm">{{ c }}</button>
                <button @click="fetchCloudData" class="ml-auto text-stone-300 p-2"><i class="fas fa-sync-alt" :class="{'fa-spin': isLoading}"></i></button>
            </div>

            <div class="grid gap-6">
                <div v-for="r in filteredRecipes" :key="r.id" @click="r.isExpanded = !r.isExpanded" class="muji-card overflow-hidden cursor-pointer active:scale-[0.99] transition-all">
                    <button @click.stop="deleteRecipe(r.id)" class="absolute top-3 right-3 w-8 h-8 bg-white/90 backdrop-blur rounded-full text-red-200 flex items-center justify-center shadow-sm z-10 active:bg-red-500 active:text-white">
                        <i class="fas fa-trash-alt text-[10px]"></i>
                    </button>
                    <img v-if="r.image" :src="r.image" class="w-full h-44 object-cover bg-stone-100">
                    <div class="p-5">
                        <div class="flex justify-between mb-2">
                            <h3 class="font-medium text-sm text-stone-700">{{ r.title }}</h3>
                            <span class="text-[9px] border px-2 py-0.5 rounded text-stone-300 uppercase font-bold">{{ r.cuisine }}</span>
                        </div>
                        <div class="text-[10px] text-[#8D6E63] font-bold mb-3">{{ r.calories }} kcal</div>
                        <p class="text-xs leading-relaxed text-stone-500" :class="r.isExpanded ? 'whitespace-pre-line' : 'line-clamp-2'">{{ r.method }}</p>
                        <div class="text-[9px] text-stone-300 mt-4 text-right">{{ r.isExpanded ? '點擊收起 ▲' : '點擊查看全文 ▼' }}</div>
                    </div>
                </div>
            </div>
        </section>

        <button @click="showModal = true" class="fixed bottom-10 right-8 w-14 h-14 muji-btn rounded-full shadow-2xl flex items-center justify-center z-30"><i class="fas fa-plus"></i></button>

        <div v-if="showModal" class="fixed inset-0 bg-stone-900/10 backdrop-blur-sm z-50 flex items-end">
            <div class="bg-white w-full rounded-t-[40px] p-8 max-h-[90vh] overflow-y-auto relative">
                <div v-if="isSaving" class="absolute inset-0 z-10 bg-white/80 flex flex-col items-center justify-center">
                    <i class="fas fa-spinner fa-spin text-[#8D6E63] mb-2"></i>
                    <p class="text-[10px] opacity-40">雲端同步中...</p>
                </div>
                <div class="flex justify-between items-center mb-8">
                    <h2 class="font-bold">分享新食譜</h2>
                    <button @click="showModal = false" class="text-2xl opacity-10">&times;</button>
                </div>
                <div class="space-y-5">
                    <div class="h-40 bg-stone-50 rounded-3xl border-2 border-dashed border-stone-100 relative overflow-hidden flex flex-col items-center justify-center text-stone-200">
                        <img v-if="newR.image" :src="newR.image" class="absolute inset-0 w-full h-full object-cover">
                        <i v-else class="fas fa-camera text-2xl"></i>
                        <input type="file" @change="handleImg" class="absolute inset-0 opacity-0" accept="image/*">
                    </div>
                    <input v-model="newR.title" @input="estimateKcal" type="text" placeholder="食譜名稱">
                    <div class="grid grid-cols-2 gap-4">
                        <select v-model="newR.cuisine"><option v-for="c in cuisines" :key="c">{{ c }}</option></select>
                        <input v-model.number="newR.calories" type="number" placeholder="kcal">
                    </div>
                    <textarea v-model="newR.method" rows="5" placeholder="做法步驟..."></textarea>
                    <button @click="saveToCloud" class="w-full py-4 muji-btn rounded-2xl font-bold shadow-lg">發佈到雲端</button>
                </div>
            </div>
        </div>
    </template>
</div>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue
const API_URL = 'https://script.google.com/macros/s/AKfycbziRXNRrmdO5tNxLnxXccRPb9bTTOSmf8nUXRXWtg2PEP9B7C5BfnOoKVqFgysbxYRH/exec';

createApp({
    setup() {
        const isUnlocked = ref(false);
        const passInput = ref('');
        const tab = ref('recommend');
        const showModal = ref(false);
        const isLoading = ref(false);
        const isSaving = ref(false);
        const filterCuisine = ref('全部');
        const cuisines = ['中式', '日式', '韓式', '西式', '其他'];
        
        const recipes = ref([]);
        const user = ref(JSON.parse(localStorage.getItem('muji_user_v3') || '{"height":"","weight":"","gender":"F"}'));
        const newR = ref({ title: '', calories: '', cuisine: '中式', method: '', image: '' });

        const checkPassword = () => { if(passInput.value === '1234') isUnlocked.value = true; else alert('密碼錯誤'); }

        const dishes = [
            {name:"清蒸鱸魚",tag:"高蛋白/補腦",cal:280}, {name:"蒜蓉西蘭花",tag:"高纖維/抗氧",cal:80},
            {name:"淮山排骨湯",tag:"健脾養胃",cal:320}, {name:"滑蛋蝦仁",tag:"嫩滑低脂",cal:250},
            {name:"南瓜燉雞",tag:"溫補益氣",cal:380}, {name:"蟲草花蒸雞",tag:"滋陰潤肺",cal:350},
            {name:"節瓜粉絲蝦米",tag:"消暑清甜",cal:180}, {name:"苦瓜炒牛肉",tag:"清熱解毒",cal:290},
            {name:"西紅柿炒雞蛋",tag:"開胃補氣",cal:220}, {name:"鮮淮山炒肉片",tag:"補脾固精",cal:260},
            {name:"木耳蒸雞",tag:"活血去瘀",cal:310}, {name:"蝦仁豆腐煲",tag:"低卡高蛋白",cal:240},
            {name:"蓮藕花生排骨湯",tag:"養血安神",cal:380}, {name:"金銀蛋浸莧菜",tag:"補鐵清熱",cal:160},
            {name:"鮑汁菇片扒菜膽",tag:"高纖維/輕食",cal:150}, {name:"冬瓜肉碎湯",tag:"利尿消腫",cal:210},
            {name:"栗子燜雞",tag:"補腎強筋",cal:420}, {name:"涼瓜排骨湯",tag:"清肝明目",cal:310},
            {name:"腰果炒蝦仁",tag:"優質油脂",cal:350}, {name:"木耳炒山藥",tag:"降壓排毒",cal:180},
            {name:"煎釀豆腐",tag:"植物蛋白",cal:280}, {name:"羅漢齋",tag:"清腸排毒",cal:140},
            {name:"梅菜蒸肉餅",tag:"開胃下飯",cal:380}, {name:"彩椒炒鮮魷",tag:"低脂/嚼勁",cal:190},
            {name:"腐竹蛋白糖水",tag:"滋潤養顏",cal:200}, {name:"老黃瓜排骨湯",tag:"清熱消暑",cal:290},
            {name:"蒜蓉粉絲蒸扇貝",tag:"鮮味低脂",cal:220}, {name:"香菇燉雞湯",tag:"增強免疫",cal:360},
            {name:"手撕包菜",tag:"爽脆纖維",cal:110}, {name:"白灼肥牛響鈴",tag:"滿足感強",cal:450}
        ];

        const solarTerms = [
            { name: "立春", date: "2/4", advice: "春氣通於肝。宜多食辛甘發散之品，如韭菜、芽菜、春筍。早起散步，放鬆心情。" },
            { name: "雨水", date: "2/19", advice: "濕氣漸重。宜健脾利濕，少食生冷寒涼，多喝溫熱粥水，注意足部保暖。" },
            { name: "驚蟄", date: "3/5", advice: "陽氣初生。宜早睡早起。飲食宜清淡，多吃梨、枇杷等滋潤之品以潤肺。" },
            { name: "春分", date: "3/20", advice: "陰陽平衡之時。宜調理陰陽，戒怒養肝。飲食應選擇甘平之品。" },
            { name: "清明", date: "4/4", advice: "氣清景明。宜戶外踏青，防風感冒。飲食以補肝、清肺為主。" },
            { name: "穀雨", date: "4/20", advice: "濕氣最重。宜柔肝養血，驅風利濕。適量喝紅豆薏米茶。" },
            { name: "立夏", date: "5/5", advice: "養心氣。宜午後微睡。飲食宜清淡低脂，多食清熱消暑瓜類。" },
            { name: "小滿", date: "5/20", advice: "濕熱加劇。宜吃綠豆清熱祛濕。保持飲食衛生，戒生冷冷飲。" },
            { name: "芒種", date: "6/5", advice: "易汗出。補充水分電解質。飲食以清補為主，多喝烏梅湯。" },
            { name: "夏至", date: "6/21", advice: "陽極陰生。宜午睡補氣。飲食宜苦酸結合，清熱燥濕。" },
            { name: "小暑", date: "7/7", advice: "炎熱開始。宜避暑氣。飲食可加一點生薑以助脾胃陽氣。" },
            { name: "大暑", date: "7/22", advice: "酷熱期。宜防暑降溫。飲食多吃西瓜、冬瓜、茯苓粥。" },
            { name: "立秋", date: "8/7", advice: "秋氣通於肺。宜滋陰潤肺，早臥早起。少吃辛辣，多食百合。" },
            { name: "處暑", date: "8/23", advice: "暑氣漸散。宜健脾潤燥。多喝蜂蜜水，早晚注意腹部保暖。" },
            { name: "白露", date: "9/7", advice: "秋燥明顯。宜養肺生津，避免受涼。飲食以滋陰補氣為主。" },
            { name: "秋分", date: "9/22", advice: "晝夜平分。宜早睡晚起。多吃秋梨、銀耳、蜂蜜等甘潤之品。" },
            { name: "寒露", date: "10/8", advice: "露氣轉寒。宜保暖雙腳。飲食宜潤肺益胃，多食芝麻。" },
            { name: "霜降", date: "10/23", advice: "寒意漸濃。宜補腎養血。吃柿子、栗子或紅薯。多運動。" },
            { name: "立冬", date: "11/7", advice: "補冬養藏。多吃黑米、黑豆、黑芝麻等「黑色入腎」之品。" },
            { name: "小雪", date: "11/22", advice: "宜補氣養血。適當進補溫性食物。注意頭頸部保暖。" },
            { name: "大雪", date: "12/7", advice: "萬物潛藏。保暖避寒。飲食補腎壯骨，如羊肉、山藥。" },
            { name: "冬至", date: "12/21", advice: "陽氣始生，宜適當進補固本。避免劇烈運動，飲食吃溫補熱食。" },
            { name: "小寒", date: "1/5", advice: "最冷之際。宜進補暖身。適度運動，多曬太陽，補充陽氣。" },
            { name: "大寒", date: "1/20", advice: "歲末將至。宜溫暖四肢，防風寒。飲食宜溫補與清淡結合。" }
        ];

        const fetchCloudData = async () => {
            isLoading.value = true;
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                recipes.value = data.sheet1.reverse().map(i => ({...i, isExpanded: false})) || [];
            } catch (e) { 
                console.error("Fetch failed"); 
            } finally { 
                isLoading.value = false; 
            }
        };

        const saveToCloud = async () => {
            if (!newR.value.title) return alert('菜名不可為空');
            isSaving.value = true;
            try {
                // 發送順序對應你指定的: title, calories, cuisine, method, image
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ sheet1: {
                        title: newR.value.title,
                        calories: newR.value.calories,
                        cuisine: newR.value.cuisine,
                        method: newR.value.method,
                        image: newR.value.image
                    } })
                });
                
                setTimeout(async () => {
                    await fetchCloudData();
                    showModal.value = false;
                    newR.value = { title: '', calories: '', cuisine: '中式', method: '', image: '' };
                    isSaving.value = false;
                }, 1000);
            } catch (e) { 
                alert('同步失敗'); 
                isSaving.value = false;
            }
        };

        const deleteRecipe = async (id) => {
            if (!confirm('確定刪除？')) return;
            try {
                await fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'DELETE', id: id }) 
                });
                setTimeout(fetchCloudData, 1000);
            } catch (e) { 
                alert('刪除失敗'); 
            }
        };

        const handleImg = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 250;
                    canvas.height = img.height * (250 / img.width);
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    newR.value.image = canvas.toDataURL('image/jpeg', 0.4);
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        };

        const estimateKcal = () => {
            const d = {'雞':350, '魚':250, '牛':450, '菜':80, '肉':380, '湯':200};
            for(let k in d) if(newR.value.title.includes(k)) { newR.value.calories = d[k]; break; }
        };

        onMounted(fetchCloudData);
        watch(user, (v) => localStorage.setItem('muji_user_v3', JSON.stringify(v)), {deep:true});

        const currentSolarTerm = computed(() => {
            const now = new Date();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            let term = solarTerms[solarTerms.length - 1]; 
            for (let i = 0; i < solarTerms.length; i++) {
                const [tM, tD] = solarTerms[i].date.split('/').map(Number);
                if (month < tM || (month === tM && day < tD)) {
                    term = solarTerms[i-1] || solarTerms[solarTerms.length-1];
                    break;
                }
            }
            return term;
        });

        const dailyDishes = computed(() => {
            const seed = new Date().getDate();
            return [dishes[seed % dishes.length], dishes[(seed + 7) % dishes.length]];
        });

        return { 
            isUnlocked, passInput, checkPassword, tab, showModal, recipes, user, newR, isLoading, isSaving,
            currentSolarTerm, dailyDishes,
            currentDate: new Date().toLocaleDateString('zh-HK'),
            bmi: computed(() => (user.value.height && user.value.weight) ? (user.value.weight / Math.pow(user.value.height/100, 2)).toFixed(1) : null),
            bmiStatus: computed(() => {
                if(!user.value.height || !user.value.weight) return '';
                const b = (user.value.weight / Math.pow(user.value.height/100, 2));
                return b < 18.5 ? 'Underweight' : b < 24 ? 'Healthy' : 'Overweight';
            }),
            recommendedKcal: computed(() => Math.round(user.value.gender === 'F' ? (user.value.weight * 22 * 1.3) : (user.value.weight * 24 * 1.3))),
            cuisines, filterCuisine, fetchCloudData, handleImg, saveToCloud, deleteRecipe, estimateKcal,
            filteredRecipes: computed(() => filterCuisine.value === '全部' ? recipes.value : recipes.value.filter(r => r.cuisine === filterCuisine.value))
        }
    }
}).mount('#app')
</script>
</body>
</html>