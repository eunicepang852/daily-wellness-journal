<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JW & EP 生活助手</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F7F3F0; color: #5D4037; -webkit-tap-highlight-color: transparent; }
        .muji-card { background-color: #FFFFFF; border-radius: 24px; box-shadow: 0 4px 15px rgba(93,64,55,0.05); overflow: hidden; position: relative; }
        .muji-btn { background-color: #8D6E63; color: white; transition: all 0.3s; }
        .muji-btn:active { transform: scale(0.95); opacity: 0.9; }
        .tab-active { border-bottom: 2px solid #8D6E63; color: #8D6E63; font-weight: 500; }
        input, select, textarea { background-color: #FBF9F7; border: 1px solid #EFEBE9; border-radius: 12px; padding: 14px; outline: none; width: 100%; font-size: 14px; }
        .btn-filter { padding: 8px 18px; border-radius: 20px; font-size: 12px; border: 1px solid #EFEBE9; background: white; color: #A8A29E; }
        .btn-filter.active { background: #8D6E63; color: white; border-color: #8D6E63; }
        .timer-active { color: #E67E22; font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-28">

<div id="app">
    <div v-if="!isUnlocked" class="fixed inset-0 z-[100] bg-[#F7F3F0] flex flex-col items-center justify-center p-10">
        <h2 class="text-xl font-medium mb-8">JW & EP 專屬空間</h2>
        <div class="grid grid-cols-2 gap-4 w-full mb-6">
            <button @click="currentUser = 'JW'" class="py-6 muji-card border-2" :class="currentUser === 'JW' ? 'border-blue-300' : 'border-transparent'">JW (男)</button>
            <button @click="currentUser = 'EP'" class="py-6 muji-card border-2" :class="currentUser === 'EP' ? 'border-[#8D6E63]' : 'border-transparent'">EP (女)</button>
        </div>
        <input v-model="passInput" type="password" placeholder="輸入密碼" class="text-center mb-4 p-4 shadow-inner" @keyup.enter="checkPassword">
        <button @click="checkPassword" class="w-full py-4 muji-btn rounded-2xl shadow-md font-bold">驗證身份</button>
    </div>

    <template v-else>
        <header class="bg-white/90 backdrop-blur-md px-6 pt-6 sticky top-0 z-20 border-b border-stone-50">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h1 class="text-2xl font-medium">{{ tabName }}</h1>
                    <div v-if="timer > 0" class="timer-active text-xs mt-1">組間休息中: {{ timer }}s</div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-bold text-[#8D6E63]">{{ solarTerm }}</div>
                    <div class="text-[10px] opacity-40">{{ currentDate }}</div>
                </div>
            </div>
            <div class="flex gap-8 text-sm text-stone-300 pb-3 overflow-x-auto no-scrollbar">
                <span @click="tab = 'recommend'" :class="{'tab-active': tab === 'recommend'}" class="cursor-pointer pb-2 whitespace-nowrap">今日建議</span>
                <span @click="tab = 'gym'" :class="{'tab-active': tab === 'gym'}" class="cursor-pointer pb-2 whitespace-nowrap">健身紀錄</span>
                <span @click="tab = 'recipes'" :class="{'tab-active': tab === 'recipes'}" class="cursor-pointer pb-2 whitespace-nowrap">共享食譜</span>
                <span @click="tab = 'health'" :class="{'tab-active': tab === 'health'}" class="cursor-pointer pb-2 whitespace-nowrap">個人指標</span>
            </div>
        </header>

        <section v-if="tab === 'recommend'" class="p-6 space-y-6">
            <div class="bg-[#8D6E63] text-white p-7 rounded-[30px] shadow-lg">
                <h2 class="text-xs font-bold mb-2 opacity-80 uppercase tracking-widest">Target Intake</h2>
                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-[10px] opacity-60">今日推薦攝取 (TDEE)</p>
                        <p class="text-4xl font-light">{{ recommendedKcal }} <span class="text-sm">kcal</span></p>
                    </div>
                    <i class="fas fa-bullseye text-3xl opacity-20"></i>
                </div>
            </div>

            <div class="bg-orange-50/50 border border-orange-100 p-6 rounded-[30px]">
                <h2 class="text-sm font-bold mb-3 flex items-center gap-2 text-orange-800">
                    <i class="fas fa-mortar-pestle"></i> {{ solarTerm }}養生建議
                </h2>
                <p class="text-xs leading-relaxed text-orange-900/70">{{ solarTermAdvice }}</p>
            </div>

            <div class="space-y-4">
                <h3 class="text-[10px] font-bold opacity-30 pl-1 uppercase tracking-widest">今日精選菜譜 (自動輪換)</h3>
                <div v-for="dish in dailyDishes" :key="dish.name" class="muji-card p-5 flex justify-between items-center">
                    <div>
                        <div class="font-medium text-sm">{{ dish.name }}</div>
                        <div class="text-[10px] opacity-40 mt-0.5">{{ dish.tag }}</div>
                    </div>
                    <div class="text-xs font-bold text-[#8D6E63]">{{ dish.cal }} kcal</div>
                </div>
            </div>
        </section>

        <section v-if="tab === 'gym'" class="p-6 space-y-6">
            <div class="muji-card p-6 border-l-4" :class="currentUser === 'JW' ? 'border-blue-400' : 'border-[#8D6E63]'">
                <div class="space-y-4">
                    <select v-model="newGym.exercise" class="text-sm">
                        <optgroup v-for="(list, cat) in exerciseLibrary" :label="cat">
                            <option v-for="ex in list" :value="ex">{{ ex }}</option>
                        </optgroup>
                    </select>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-stone-50 p-4 rounded-2xl text-center">
                            <p class="text-[10px] opacity-40 mb-1">重量 kg</p>
                            <div class="flex justify-between items-center font-bold">
                                <button @click="newGym.weight = Math.max(0, newGym.weight-2.5)">-</button>
                                <span>{{ newGym.weight }}</span>
                                <button @click="newGym.weight += 2.5">+</button>
                            </div>
                        </div>
                        <div class="bg-stone-50 p-4 rounded-2xl text-center">
                            <p class="text-[10px] opacity-40 mb-1">次數 reps</p>
                            <div class="flex justify-between items-center font-bold">
                                <button @click="newGym.reps = Math.max(1, newGym.reps-1)">-</button>
                                <span>{{ newGym.reps }}</span>
                                <button @click="newGym.reps++">+</button>
                            </div>
                        </div>
                    </div>
                    <button @click="saveGymLog" :disabled="isSaving" class="w-full py-4 muji-btn rounded-2xl shadow-lg font-bold">
                        {{ isSaving ? '同步雲端中...' : '儲存紀錄並倒數' }}
                    </button>
                </div>
            </div>
            <div class="space-y-4">
                <h3 class="text-[10px] font-bold opacity-30 uppercase tracking-widest px-1">今日訓練總結</h3>
                <div v-if="todayLogs.length === 0" class="text-center py-10 muji-card opacity-20 text-xs italic">今日尚未開始訓練</div>
                <div v-for="log in todayLogs" :key="log.id" class="muji-card p-5 flex justify-between items-center">
                    <div>
                        <div class="text-sm font-medium">{{ log.exercise }}</div>
                        <div class="text-[10px] opacity-30 mt-1">{{ log.time }}</div>
                    </div>
                    <div class="text-sm font-bold text-[#8D6E63]">{{ log.weight }}kg x {{ log.reps }}</div>
                </div>
            </div>
        </section>

        <section v-if="tab === 'recipes'" class="p-6 space-y-6">
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-stone-300 text-xs"></i>
                <input v-model="searchQuery" type="text" placeholder="搜尋菜名..." class="pl-10 p-3 shadow-sm border-none bg-white">
            </div>
            <div class="flex items-center gap-3 overflow-x-auto no-scrollbar pb-1">
                <button v-for="c in ['全部', '中式', '日式', '西式', '東南亞', '其他']" :key="c" @click="filterCuisine = c" :class="filterCuisine === c ? 'active' : ''" class="btn-filter shadow-sm">{{ c }}</button>
            </div>
            <div class="grid gap-6">
                <div v-for="r in filteredRecipes" :key="r.id" @click="r.isExpanded = !r.isExpanded" class="muji-card">
                    <button @click.stop="deleteRecipe(r.id)" class="absolute top-3 right-3 w-8 h-8 bg-white/90 rounded-full text-red-200 flex items-center justify-center z-10 active:bg-red-500 active:text-white">
                        <i class="fas fa-trash-alt text-[10px]"></i>
                    </button>
                    <img v-if="r.image" :src="r.image" class="w-full h-44 object-cover">
                    <div class="p-5">
                        <div class="flex justify-between mb-1">
                            <h3 class="font-medium text-sm">{{ r.title }}</h3>
                            <span class="text-[9px] border px-2 py-0.5 rounded text-stone-300">{{ r.cuisine }}</span>
                        </div>
                        <div class="text-[10px] text-[#8D6E63] font-bold mb-3">{{ r.calories }} kcal</div>
                        <p class="text-xs text-stone-500" :class="r.isExpanded ? 'whitespace-pre-line' : 'line-clamp-2'">{{ r.method }}</p>
                    </div>
                </div>
            </div>
        </section>

        <section v-if="tab === 'health'" class="p-6 space-y-6">
            <div class="muji-card p-8 text-center">
                <h2 class="text-[10px] font-bold opacity-30 uppercase tracking-widest mb-6">{{ currentUser }} 身體數據</h2>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="text-left">
                        <label class="text-[10px] opacity-40 ml-1">身高 (cm)</label>
                        <input v-model.number="userStats[currentUser].height" type="number">
                    </div>
                    <div class="text-left">
                        <label class="text-[10px] opacity-40 ml-1">體重 (kg)</label>
                        <input v-model.number="userStats[currentUser].weight" type="number">
                    </div>
                </div>
                <div class="bg-stone-50 p-6 rounded-3xl">
                    <div class="text-xs opacity-40 mb-1">當前 BMI</div>
                    <div class="text-4xl font-light">{{ currentBMI }}</div>
                </div>
            </div>
        </section>

        <button v-if="tab === 'recipes'" @click="showModal = true" class="fixed bottom-10 right-8 w-14 h-14 muji-btn rounded-full shadow-2xl flex items-center justify-center z-30"><i class="fas fa-plus"></i></button>

        <div v-if="showModal" class="fixed inset-0 bg-stone-900/10 backdrop-blur-sm z-50 flex items-end">
            <div class="bg-white w-full rounded-t-[40px] p-8 max-h-[90vh] overflow-y-auto relative">
                <div class="flex justify-between items-center mb-6"><h2 class="font-bold">分享新食譜</h2><button @click="showModal = false" class="text-2xl opacity-10">&times;</button></div>
                <div class="space-y-4">
                    <div class="h-44 bg-stone-50 rounded-3xl border-2 border-dashed border-stone-100 relative overflow-hidden flex flex-col items-center justify-center text-stone-300">
                        <img v-if="newR.image" :src="newR.image" class="absolute inset-0 w-full h-full object-cover">
                        <i v-else class="fas fa-camera text-2xl"></i>
                        <input type="file" @change="handleImg" class="absolute inset-0 opacity-0" accept="image/*">
                    </div>
                    <input v-model="newR.title" @input="estimateKcal" placeholder="食譜名稱">
                    <div class="grid grid-cols-2 gap-4">
                        <select v-model="newR.cuisine"><option>中式</option><option>日式</option><option>西式</option><option>其他</option></select>
                        <input v-model.number="newR.calories" type="number" placeholder="熱量 kcal">
                    </div>
                    <textarea v-model="newR.method" rows="5" placeholder="準備食材與做法..."></textarea>
                    <button @click="saveRecipe" class="w-full py-4 muji-btn rounded-2xl font-bold">存入共享庫</button>
                </div>
            </div>
        </div>
    </template>
</div>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;
const API_BASE = 'https://api.sheety.co/c1fb791480e9ebd8137b59f1a8c90cec/wellnessDb';

const SOLAR_TERMS_DATA = [
    {m:1,d:6,n:"小寒",a:"寒冷至極。宜補充：黨參、當歸、生薑燉肉，溫補腎氣。"},
    {m:1,d:20,n:"大寒",a:"冬去春來。宜補充：糯米、紅糖、生薑湯，暖胃防寒。"},
    {m:2,d:4,n:"立春",a:"大地回春。宜補充：春芽、韭菜、菠菜，疏肝理氣。"},
    {m:2,d:19,n:"雨水",a:"濕氣漸增。宜補充：山藥、茯苓、薏米，健脾除濕。"},
    {m:3,d:6,n:"驚蟄",a:"陽氣初動。宜補充：梨、枇杷、銀耳，潤肺滋陰。"},
    {m:3,d:21,n:"春分",a:"陰陽平衡。宜補充 : 桑椹、杞子，平衡肝火。"},
    {m:4,d:5,n:"清明",a:"清爽明淨。宜補充：菊花茶、薺菜，清肝明目。"},
    {m:4,d:20,n:"穀雨",a:"雨生百穀。宜補充：赤小豆、黑豆，利水消腫。"},
    {m:5,d:6,n:"立夏",a:"夏季開始。宜補充：蓮子心、百合、西紅柿，清心去火。"},
    {m:5,d:21,n:"小滿",a:"穀物漸滿。宜補充：苦瓜、綠豆，清熱解毒。"},
    {m:6,d:6,n:"芒種",a:"氣候炎熱。宜補充：桑椹、酸梅湯，生津止渴。"},
    {m:6,d:21,n:"夏至",a:"陽氣最旺。宜補充：冬瓜、西瓜，消暑利濕。"},
    {m:7,d:7,n:"小暑",a:"暑氣漸生。宜補充：綠豆湯、蓮藕，解暑健脾。"},
    {m:7,d:23,n:"大暑",a:"一年最熱。宜補充：茯苓粥、西瓜翠衣，清熱排毒。"},
    {m:8,d:8,n:"立秋",a:"秋風漸起。宜補充：銀耳、雪梨，潤燥生津。"},
    {m:8,d:23,n:"處暑",a:"暑氣消退。宜補充：百合、蓮子，滋陰潤肺。"},
    {m:9,d:8,n:"白露",a:"露凝而白。宜補充：龍眼、大棗，益氣補血。"},
    {m:9,d:23,n:"秋分",a:"晝夜平分。宜補充：芝麻、核桃，滋陰防燥。"},
    {m:10,d:8,n:"寒露",a:"露寒欲凝。宜補充：石榴、山楂，酸甘化陰。"},
    {m:10,d:24,n:"霜降",a:"氣溫驟降。宜補充：栗子、柿子，健脾養胃。"},
    {m:11,d:8,n:"立冬",a:"冬季開始。宜補充：黑豆、黑木耳，補腎養血。"},
    {m:11,d:22,n:"小雪",a:"水凝成冰。宜補充：羊肉、桂圓，暖身補陽。"},
    {m:12,d:7,n:"大雪",a:"至此而大。宜補充：紅薯、山藥，益氣強身。"},
    {m:12,d:22,n:"冬至",a:"陽氣始生。宜補充：黑芝麻、核桃，溫補腎陽。"}
];

createApp({
    setup() {
        const isUnlocked = ref(false);
        const currentUser = ref('EP');
        const passInput = ref('');
        const tab = ref('recommend');
        const timer = ref(0);
        const timerId = ref(null);
        const isSaving = ref(false);
        const showModal = ref(false);
        const searchQuery = ref('');
        const filterCuisine = ref('全部');

        const recipes = ref([]);
        const gymLogs = ref([]);
        const newR = ref({ title: '', calories: '', image: '', cuisine: '中式', method: '' });
        const newGym = ref({ exercise: 'Dead Bug (死蟲式)', weight: 0, reps: 12 });
        const userStats = ref(JSON.parse(localStorage.getItem('muji_stats_v9') || '{"JW":{"height":175,"weight":70,"gender":"M"},"EP":{"height":160,"weight":50,"gender":"F"}}'));

        // 【資料還原】所有的運動動作
        const exerciseLibrary = {
          '體態修正/核心': [
            'Dead Bug (死蟲式)', 'Plank', 'Side Plank', 'Plank Shoulder Tap',
            'Glute Bridge', 'Hip Thrust', 'Bird Dog', 'Pelvic Tilt',
            'Russian Twist', 'Leg Raise', 'Hanging Leg Raise',
            'Hollow Hold', 'Superman', 'Back Extension',
            'Cat-Cow', 'Ab Wheel Rollout', 'Cable Crunch', 'Reverse Crunch',
            'Pallof Press', 'Dead Hang'
          ],
          '胸部/推力': [
            'Chest Press (Machine)', 'Push Up', 'Incline Push Up',
            'Dumbbell Bench Press', 'Barbell Bench Press',
            'Incline Dumbbell Press', 'Decline Bench Press',
            'Chest Fly (Machine)', 'Cable Fly (High to Low)',
            'Cable Fly (Low to High)', 'Pec Deck',
            'Shoulder Press (Machine)', 'Dumbbell Shoulder Press',
            'Arnold Press', 'Landmine Press',
            'Lateral Raise', 'Front Raise',
            'Cable Lateral Raise', 'Push Press', 'Chest Dips'
          ],
          '背部/拉力': [
            'Seated Row', 'Wide Grip Seated Row',
            'Lat Pulldown', 'Close Grip Lat Pulldown',
            'Assisted Pull Up', 'Pull Up',
            'Chin Up', 'Face Pull',
            'Single Arm Dumbbell Row', 'Bent Over Row',
            'Barbell Row', 'T-Bar Row',
            'Reverse Fly (Machine)', 'Reverse Fly (Dumbbell)',
            'Straight Arm Pulldown',
            'Cable Row (Single Arm)', 'Meadows Row',
            'Inverted Row', 'Shrug', 'Deadlift'
          ],
          '腿部/下肢': [
            'Leg Press', 'Goblet Squat', 'Barbell Back Squat',
            'Front Squat', 'Hack Squat',
            'Walking Lunge', 'Reverse Lunge',
            'Bulgarian Split Squat',
            'Step Up', 'Box Squat',
            'Leg Extension', 'Single Leg Extension',
            'Leg Curl (Seated)', 'Leg Curl (Lying)',
            'Romanian Deadlift (Dumbbell)',
            'Romanian Deadlift (Barbell)',
            'Hip Abduction Machine', 'Hip Adduction Machine',
            'Standing Calf Raise', 'Seated Calf Raise'
          ],
          '手臂/肩部': [
            'Bicep Curl (Dumbbell)', 'Barbell Curl',
            'EZ Bar Curl', 'Cable Curl',
            'Hammer Curl', 'Concentration Curl',
            'Tricep Pushdown', 'Rope Tricep Pushdown',
            'Overhead Tricep Extension',
            'Skull Crusher',
            'Close Grip Bench Press',
            'Kickback',
            'Upright Row',
            'Rear Delt Fly',
            'Cable Face Pull',
            'Dumbbell Shrug',
            'Farmer Carry',
            'Plate Raise',
            'Zottman Curl',
            'Cross Body Hammer Curl'
          ]
        };

        // 【資料還原】所有的精選菜譜 (30道)
        const dishes = [
            {name:"清蒸鱸魚",tag:"高蛋白/補腦",cal:280}, {name:"蒜蓉西蘭花",tag:"高纖維/抗氧",cal:80},
            {name:"淮山排骨湯",tag:"健脾養胃",cal:320}, {name:"滑蛋蝦仁",tag:"嫩滑低脂",cal:250},
            {name:"南瓜燉雞",tag:"溫補益氣",cal:380}, {name:"蟲草花蒸雞",tag:"滋陰潤肺",cal:350},
            {name:"節瓜粉絲蝦米",tag:"消暑清甜",cal:180}, {name:"苦瓜炒牛肉",tag:"清熱解毒",cal:290},
            {name:"西紅柿炒雞蛋",tag:"開胃補氣",cal:220}, {name:"鮮淮山炒肉片",tag:"補脾固精",cal:260},
            {name:"木耳蒸雞",tag:"活血去瘀",cal:310}, {name:"蝦仁豆腐煲",tag:"低卡高蛋白",cal:240},
            {name:"蓮藕花生排骨湯",tag:"養血安神",cal:380}, {name:"金銀蛋浸莧菜",tag:"補鐵清熱",cal:160},
            {name:"鮑汁菇片扒菜膽",tag:"高纖維/輕食",cal:150}, {name:"冬瓜肉碎湯",tag:"利尿消腫",cal:210},
            {name:"栗子燜雞",tag:"補腎強筋",cal:420}, {name:"涼瓜排骨湯",tag:"清肝明目",cal:310},
            {name:"腰果炒蝦仁",tag:"優質油脂",cal:350}, {name:"木耳炒山藥",tag:"降壓排毒",cal:180},
            {name:"煎釀豆腐",tag:"植物蛋白",cal:280}, {name:"羅漢齋",tag:"清腸排毒",cal:140},
            {name:"梅菜蒸肉餅",tag:"開胃下飯",cal:380}, {name:"彩椒炒鮮魷",tag:"低脂/嚼勁",cal:190},
            {name:"腐竹蛋白糖水",tag:"滋潤養顏",cal:200}, {name:"老黃瓜排骨湯",tag:"清熱消暑",cal:290},
            {name:"蒜蓉粉絲蒸扇貝",tag:"鮮味低脂",cal:220}, {name:"香菇燉雞湯",tag:"增強免疫",cal:360},
            {name:"手撕包菜",tag:"爽脆纖維",cal:110}, {name:"白灼肥牛響鈴",tag:"滿足感強",cal:450}
        ];

        const currentTermData = computed(() => {
            const today = new Date();
            const m = today.getMonth() + 1;
            const d = today.getDate();
            let found = SOLAR_TERMS_DATA[SOLAR_TERMS_DATA.length - 1];
            for (let term of SOLAR_TERMS_DATA) {
                if (m > term.m || (m === term.m && d >= term.d)) found = term;
            }
            return found;
        });

        const checkPassword = () => { if(passInput.value === '0303') isUnlocked.value = true; };

        const fetchAll = async () => {
            try {
                const [r, g] = await Promise.all([fetch(`${API_BASE}/sheet1`), fetch(`${API_BASE}/gymLog`)]);
                const rData = await r.json(); const gData = await g.json();
                recipes.value = rData.sheet1.reverse().map(i => ({...i, isExpanded: false})) || [];
                gymLogs.value = gData.gymLog || [];
            } catch(e) { console.error("Cloud Sync Error"); }
        };

        const saveRecipe = async () => {
            if (!newR.value.title) return alert('請輸入菜名');
            isSaving.value = true;
            await fetch(`${API_BASE}/sheet1`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sheet1: newR.value }) });
            await fetchAll();
            showModal.value = false; isSaving.value = false;
            newR.value = { title: '', calories: '', image: '', cuisine: '中式', method: '' };
        };

        const deleteRecipe = async (id) => {
            if (!confirm('確定刪除這份共享食譜嗎？')) return;
            await fetch(`${API_BASE}/sheet1/${id}`, { method: 'DELETE' });
            await fetchAll();
        };

        const saveGymLog = async () => {
            isSaving.value = true;
            const log = { ...newGym.value, user: currentUser.value, date: new Date().toLocaleDateString('zh-HK'), time: new Date().toLocaleTimeString('zh-HK', {hour:'2-digit', minute:'2-digit'}) };
            await fetch(`${API_BASE}/gymLog`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ gymLog: log }) });
            await fetchAll();
            isSaving.value = false;
            timer.value = currentUser.value === 'EP' ? 60 : 90;
            if(timerId.value) clearInterval(timerId.value);
            timerId.value = setInterval(() => { if(timer.value > 0) timer.value--; else clearInterval(timerId.value); }, 1000);
        };

        const handleImg = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 400; canvas.height = img.height * (400 / img.width);
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    newR.value.image = canvas.toDataURL('image/jpeg', 0.6);
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        };

        const estimateKcal = () => {
            const dict = {'雞':350, '魚':250, '牛':450, '菜':80, '蛋':140, '豬':400};
            for(let k in dict) if(newR.value.title.includes(k)) { newR.value.calories = dict[k]; break; }
        };

        onMounted(fetchAll);
        watch(userStats, (v) => localStorage.setItem('muji_stats_v9', JSON.stringify(v)), {deep:true});

        return {
            isUnlocked, passInput, checkPassword, tab, timer, currentUser, recipes, gymLogs, userStats, newR, newGym, searchQuery, filterCuisine, isSaving, showModal, exerciseLibrary,
            currentDate: new Date().toLocaleDateString('zh-HK'),
            solarTerm: computed(() => currentTermData.value.n),
            solarTermAdvice: computed(() => currentTermData.value.a),
            tabName: computed(() => ({recommend:'今日建議', gym:'健身紀錄', recipes:'共享食譜', health:'個人指標'}[tab.value])),
            currentBMI: computed(() => { const s = userStats.value[currentUser.value]; return s.height ? (s.weight / Math.pow(s.height/100, 2)).toFixed(1) : 0; }),
            recommendedKcal: computed(() => { const s = userStats.value[currentUser.value]; return Math.round(s.gender === 'F' ? (s.weight * 22 * 1.3) : (s.weight * 24 * 1.3)); }),
            dailyDishes: computed(() => {
                const day = new Date().getDate();
                return [dishes[day % dishes.length], dishes[(day + 1) % dishes.length]];
            }),
            todayLogs: computed(() => gymLogs.value.filter(l => l.user === currentUser.value && l.date === new Date().toLocaleDateString('zh-HK')).reverse()),
            filteredRecipes: computed(() => recipes.value.filter(r => (filterCuisine.value === '全部' || r.cuisine === filterCuisine.value) && (r.title.includes(searchQuery.value) || r.method?.includes(searchQuery.value)))),
            saveRecipe, deleteRecipe, saveGymLog, handleImg, estimateKcal
        }
    }
}).mount('#app')
</script>
</body>
</html>